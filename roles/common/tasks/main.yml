- name: Copy sshd config
  copy:
    src: files/sshd_config
    dest: /etc/ssh/sshd_config
    force: yes

- name: Copy authorized users public keys
  copy:
    src: files/authorized_keys
    dest: ~/.ssh/authorized_keys
    force: yes

- name: Reload ssh daemon
  systemd:
    state: restarted
    daemon_reload: yes
    name: sshd

- name: Turnoff swap
  command: swapoff -a

- name: Setup package manager and install base packages for RHEL
  include_tasks: redhat.yml
  when: ansible_facts['os_family']|lower == 'redhat'
  register: RHEL

- name: Setup package manager and install base packages for Ubuntu
  include_tasks: debian.yml
  when: ansible_facts['os_family']|lower == 'debian'
  register: debian

- name: Check dummy
  shell: ip addr | grep "dummy0"
  register: rc

- name: Dummy interface
  when: when.rc != 0
  block:
    - name: Create dummy interface
      shell: echo "dummy" > /etc/modules-load.d/dummy.conf

    - name: Enable modprobe
      command: modprobe  dummy

    - name: Copy network
      template:
        src: template/dummy0.netdev
        dest: /etc/systemd/network

    - name: Copy netdev
      copy:
        src: files/dummy0.network
        dest: /etc/systemd/network

    - name: Restart systemd-networkd
      systemd:
        name: systemd-networkd
        state: restarted
        enabled: yes

- name: Check bind
  stat:
    path: "/etc/bird/bird.conf"
  register: result

- name: Setup bind
  when: result.stat.exists
  block:
    - name: Install bird on RHEL
      dnf:
        name:
          - bird
        state: latest
      when: ansible_facts['os_family']|lower == 'redhat'

    - name: Install bird on Debian
      apt:
        name: bird
      when: ansible_facts['os_family']|lower == 'debian'

    - name: Copy config file on RHEL
      template:
        src: template/bird.conf
        dest: /etc/bird/bird.conf
      when: ansible_facts['os_family']|lower == 'redhat'
      vars:
        interface_name: "eth*"

    - name: Copy config file on Debian
      template:
        src: template/bird.conf
        dest: /etc/bird/bird.conf
      when: ansible_facts['os_family']|lower == 'debian'
      vars:
        interface_name: "ens*"
